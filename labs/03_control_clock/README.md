## Задание 03 "control_clock"

В этом задании мы повысим частоту тактирования микроконтроллера до 48 МГц, а также посмотрим на такой интересный параметр 
как задержка работы FLASH памяти.

Итак, для начала возьмем пустой проект main.c и подключим к нему несколько библиотек. Так как мы собираемся использовать модуль тактирования, то подключим:

```c
#include "stm32f0xx_ll_rcc.h"
#include "stm32f0xx_ll_system.h"
```

Помимо это, чтобы задать частоту тактирования различных шин (APB, AHB), нам необходима следующая библиотека:

```c
#include "stm32f0xx_ll_bus.h"
```

Ну и напоследок для демонстрации мы будем мигать светодиодом, установленным на отладочной плате (подробнее о GPIO в следующих лекциях), поэтому:

```c
#include "stm32f0xx_ll_gpio.h"
```

Теперь перейдем к написанию функции для установки частоты тактирования, создадим пустую функцию rcc_config:

```c
static void rcc_config()
{
}
```

Ключевое слово **static** необходимо, чтобы функция не была видна из других модулей, таким образом она может вызвана в пределах данного файла.

Так как мы собираемся выставить частоту тактирования 48 МГц, то необходимо увеличить задержку обращения к FLASH памяти:

```c
    LL_FLASH_SetLatency(LL_FLASH_LATENCY_1);
```

Как мы знаем, на отладочной плане нет внешнего источника тактирования для контроллера, поэтому еще раз переключимся на источник внутреннего тактирования и дождемся стабилизации частоты:

```c
    LL_RCC_HSI_Enable();
    while (LL_RCC_HSI_IsReady() != 1);
```

Так как частота внутреннего генератора всего 8МГц, настроим PLL, чтобы получить 48МГц. Например, можно поделить входную частоту на 2 и домножить на 12. Как обычно, после настройки включим сам модуль и дождемся его готовности:

```c
    LL_RCC_PLL_ConfigDomain_SYS(LL_RCC_PLLSOURCE_HSI_DIV_2,
                                LL_RCC_PLL_MUL_12);

    LL_RCC_PLL_Enable();
    while (LL_RCC_PLL_IsReady() != 1);
```

Теперь настроим делитель для шины AHB и выставим PLL как источник для системной частоты:

```c
    LL_RCC_SetAHBPrescaler(LL_RCC_SYSCLK_DIV_1);
    LL_RCC_SetSysClkSource(LL_RCC_SYS_CLKSOURCE_PLL);
    while (LL_RCC_GetSysClkSource() != LL_RCC_SYS_CLKSOURCE_STATUS_PLL);
```

Напоследок, установим частоту для шины APB:

```c
    LL_RCC_SetAPB1Prescaler(LL_RCC_APB1_DIV_1);
```

Теперь добавим вызов данной функции в main. После загрузки данного кода микроконтроллер будет работать на частоте 48МГц!

